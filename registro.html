<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Conecta Bairro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
    <!-- Acessibilidade CSS -->
    <link href="css/accessibility.css" rel="stylesheet">
    
    <!-- VLibras Widget -->
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>new window.VLibras.Widget('https://vlibras.gov.br/app');</script>

    <style>
        .register-container {
            min-height: 100vh;
            background: linear-gradient(rgba(79, 70, 229, 0.1), rgba(79, 70, 229, 0.1)),
                        url('img/register-bg.jpg') center/cover;
            padding: 2rem 0;
        }
        
        .register-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
        }
        
        .type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .type-card {
            flex: 1;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .type-card.active {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .type-card i {
            font-size: 2rem;
            color: #4f46e5;
            margin-bottom: 1rem;
        }
        
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
        }
        
        .progress-bar {
            height: 0.5rem;
            background-color: #e2e8f0;
            border-radius: 1rem;
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }
        
        .service-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .category-checkbox {
            display: none;
        }
        
        .category-label {
            display: block;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-checkbox:checked + .category-label {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .error-message {
            display: none;
            color: #dc2626;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Controles de Acessibilidade -->
    <div class="accessibility-controls">
        <button class="accessibility-button" id="audioButton" aria-label="Ouvir instru√ß√µes da p√°gina">
            <span class="theme-icon" aria-hidden="true">üîä</span>
            <span class="theme-text">Ouvir P√°gina</span>
        </button>
    </div>

    <!-- Link para pular para o conte√∫do principal -->
    <a href="#register-content" class="skip-to-main">Pular para o conte√∫do principal</a>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" role="navigation">
        <div class="container">
            <a class="navbar-brand" href="index.html" aria-label="Voltar para a p√°gina inicial">Conecta Bairro</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="servicos.html">Servi√ßos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contato.html">Contato</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="login.html" class="btn btn-outline-primary">J√° tem uma conta? Entre</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="register-container">
        <div class="container">
            <div id="register-content" class="register-card" role="main" aria-labelledby="register-title">
                <h1 id="register-title" class="text-center mb-4">Crie sua conta</h1>
                <div class="text-center mb-3">
                    <a href="login.html" class="btn btn-sm btn-outline-secondary" id="backToLoginBtn">Voltar ao login</a>
                </div>
                
                <!-- Tipo de Conta -->
                <div class="type-selector" role="radiogroup" aria-label="Selecione o tipo de conta">
                    <div class="type-card active" 
                         data-type="cliente" 
                         onclick="selectType('cliente')" 
                         role="radio" 
                         aria-checked="true"
                         tabindex="0"
                         aria-label="Tipo de conta: Cliente - Procuro servi√ßos"
                         onkeypress="if(event.key === 'Enter' || event.key === ' ') selectType('cliente')">
                        <i class="fas fa-user" aria-hidden="true"></i>
                        <h3 class="h5">Cliente</h3>
                        <p class="text-muted">Procuro servi√ßos</p>
                    </div>
                    <div class="type-card" 
                         data-type="profissional" 
                         onclick="selectType('profissional')" 
                         role="radio" 
                         aria-checked="false"
                         tabindex="0"
                         aria-label="Tipo de conta: Profissional - Ofere√ßo servi√ßos"
                         onkeypress="if(event.key === 'Enter' || event.key === ' ') selectType('profissional')">
                        <i class="fas fa-tools" aria-hidden="true"></i>
                        <h3 class="h5">Profissional</h3>
                        <p class="text-muted">Ofere√ßo servi√ßos</p>
                    </div>
                </div>

                <!-- Barra de Progresso -->
                <div class="progress-bar" role="progressbar" aria-label="Progresso do registro" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-fill" style="width: 33%"></div>
                </div>

                <!-- Formul√°rio -->
                <form id="registerForm" onsubmit="return handleSubmit(event)" role="form" aria-label="Formul√°rio de registro">
                    <!-- alerta de valida√ß√£o -->
                    <div id="formAlert" style="display:none; margin-bottom:1rem;"></div>
                    <!-- Passo 1: Informa√ß√µes B√°sicas -->
                    <div class="form-step active" id="step1">
                        <h3 class="h4 mb-4">Informa√ß√µes B√°sicas</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome completo</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CPF</label>
                                <input type="text" class="form-control" id="cpf" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Senha</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Confirmar senha</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Pr√≥ximo</button>
                        </div>
                    </div>

                    <!-- Passo 2: Endere√ßo -->
                    <div class="form-step" id="step2">
                        <h3 class="h4 mb-4">Endere√ßo</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">CEP</label>
                                <input type="text" class="form-control" id="cep" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="neighborhood" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Rua</label>
                                <input type="text" class="form-control" id="street" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">N√∫mero</label>
                                <input type="text" class="form-control" id="number" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Complemento</label>
                                <input type="text" class="form-control" id="complement">
                            </div>
                        </div>
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevStep()">Voltar</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Pr√≥ximo</button>
                        </div>
                    </div>

                    <!-- Passo 3: Informa√ß√µes Profissionais (apenas para prestadores) -->
                    <div class="form-step" id="step3">
                        <div id="clientStep3">
                            <h3 class="h4 mb-4">Confirmar Cadastro</h3>
                            <p>Revise suas informa√ß√µes antes de finalizar o cadastro.</p>
                            <div class="mt-4 d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary" onclick="prevStep()">Voltar</button>
                                <button type="submit" class="btn btn-primary">Concluir Cadastro</button>
                            </div>
                        </div>

                        <div id="professionalStep3" style="display: none;">
                            <h3 class="h4 mb-4">Informa√ß√µes Profissionais</h3>
                            <div class="mb-4">
                                <label class="form-label">Categorias de Servi√ßo</label>
                                <div class="service-categories">
                                    <input type="checkbox" id="cat1" class="category-checkbox" name="categories[]" value="limpeza">
                                    <label for="cat1" class="category-label">Limpeza</label>

                                    <input type="checkbox" id="cat2" class="category-checkbox" name="categories[]" value="manutencao">
                                    <label for="cat2" class="category-label">Manuten√ß√£o</label>

                                    <input type="checkbox" id="cat3" class="category-checkbox" name="categories[]" value="reformas">
                                    <label for="cat3" class="category-label">Reformas</label>

                                    <input type="checkbox" id="cat4" class="category-checkbox" name="categories[]" value="eletrica">
                                    <label for="cat4" class="category-label">El√©trica</label>

                                    <input type="checkbox" id="cat5" class="category-checkbox" name="categories[]" value="hidraulica">
                                    <label for="cat5" class="category-label">Hidr√°ulica</label>

                                    <input type="checkbox" id="cat6" class="category-checkbox" name="categories[]" value="pintura">
                                    <label for="cat6" class="category-label">Pintura</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descri√ß√£o dos Servi√ßos</label>
                                <textarea class="form-control" id="description" rows="4" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pre√ßo por hora (R$)</label>
                                <input type="number" class="form-control" id="hourlyRate" required>
                            </div>
                            <div class="mt-4 d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary" onclick="prevStep()">Voltar</button>
                                <button type="submit" class="btn btn-primary">Concluir Cadastro</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JavaScript de Acessibilidade -->
    <script src="js/accessibility.js"></script>
    <script>
        // Inicializar acessibilidade com instru√ß√µes espec√≠ficas da p√°gina
        const pageInstructions = `
            Esta √© a p√°gina de registro do Conecta Bairro.
            O formul√°rio possui tr√™s etapas:
            1. Informa√ß√µes b√°sicas como nome e email
            2. Endere√ßo
            3. Informa√ß√µes profissionais (apenas para prestadores de servi√ßo)
            Use Tab para navegar entre os campos e Enter para avan√ßar.
        `;
        document.addEventListener('DOMContentLoaded', () => {
            AccessibilityManager.init(pageInstructions);
        });

        let currentStep = 1;
        let userType = 'cliente';

        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('formAlert');
            alertContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
            alertContainer.style.display = 'block';
            // rolar para o alerta
            const rect = alertContainer.getBoundingClientRect();
            window.scrollTo({ top: window.scrollY + rect.top - 20, behavior: 'smooth' });
        }

        function clearAlert() {
            const alertContainer = document.getElementById('formAlert');
            alertContainer.innerHTML = '';
            alertContainer.style.display = 'none';
        }

        function selectType(type) {
            userType = type;
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.remove('active');
                card.setAttribute('aria-checked', 'false');
            });
            const selectedCard = document.querySelector(`[data-type="${type}"]`);
            selectedCard.classList.add('active');
            selectedCard.setAttribute('aria-checked', 'true');

            // Mostrar/ocultar campos espec√≠ficos
            if (type === 'profissional') {
                document.getElementById('clientStep3').style.display = 'none';
                document.getElementById('professionalStep3').style.display = 'block';
            } else {
                document.getElementById('clientStep3').style.display = 'block';
                document.getElementById('professionalStep3').style.display = 'none';
            }

            // Anunciar mudan√ßa para leitores de tela
            AccessibilityManager.announceMessage(`Tipo de conta selecionado: ${type === 'cliente' ? 'Cliente' : 'Profissional'}`);
        }

        function switchToStep(step) {
            document.querySelectorAll('.form-step').forEach(el => {
                el.classList.remove('active');
                el.setAttribute('aria-hidden', 'true');
            });
            const newStep = document.getElementById(`step${step}`);
            newStep.classList.add('active');
            newStep.setAttribute('aria-hidden', 'false');
            currentStep = step;
            updateProgress();

            // Anunciar mudan√ßa de etapa para leitores de tela
            const stepTitles = {
                1: 'Informa√ß√µes B√°sicas',
                2: 'Endere√ßo',
                3: userType === 'profissional' ? 'Informa√ß√µes Profissionais' : 'Confirmar Cadastro'
            };
            AccessibilityManager.announceMessage(`Etapa ${step} de 3: ${stepTitles[step]}`);
        }

        function nextStep() {
            const res = validateStep(currentStep);
            if (!res.valid) {
                showAlert(res.message);
                if (res.field) {
                    res.field.focus();
                }
                return;
            }
            clearAlert();
            if (currentStep < 3) {
                switchToStep(currentStep + 1);
            }
        }

        function prevStep() {
            clearAlert();
            if (currentStep > 1) {
                switchToStep(currentStep - 1);
            }
        }

        function updateProgress() {
            // 3 passos no total
            const progress = (currentStep / 3) * 100;
            const progressBar = document.querySelector('.progress-bar');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressFill.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            
            // Anunciar progresso para leitores de tela
            if (progress === 100) {
                AccessibilityManager.announceMessage('Formul√°rio completo!');
            }
        }

        function validateStep(step) {
            // retorna { valid: bool, message: string, field: element }
            const get = id => document.getElementById(id);
            if (step === 1) {
                const required = ['name', 'cpf', 'email', 'phone', 'password', 'confirmPassword'];
                for (const id of required) {
                    const el = get(id);
                    if (!el || !el.value.trim()) {
                        return { valid: false, message: 'Preencha o campo: ' + (el.previousElementSibling?.innerText || id), field: el };
                    }
                }
                const pwd = get('password').value;
                const cpwd = get('confirmPassword').value;
                if (pwd !== cpwd) {
                    return { valid: false, message: 'As senhas n√£o coincidem.', field: get('confirmPassword') };
                }
            }

            if (step === 2) {
                const required = ['cep', 'neighborhood', 'street', 'number'];
                for (const id of required) {
                    const el = get(id);
                    if (!el || !el.value.trim()) {
                        return { valid: false, message: 'Preencha o campo: ' + (el.previousElementSibling?.innerText || id), field: el };
                    }
                }
            }

            if (step === 3) {
                if (userType === 'profissional') {
                    const categories = Array.from(document.querySelectorAll('input[name="categories[]"]:checked'))
                        .map(cb => cb.value);
                    if (categories.length === 0) {
                        return { valid: false, message: 'Selecione pelo menos uma categoria de servi√ßo.', field: document.getElementById('cat1') };
                    }
                    const desc = get('description');
                    if (!desc || !desc.value.trim()) {
                        return { valid: false, message: 'Preencha a descri√ß√£o dos servi√ßos.', field: desc };
                    }
                    const rate = get('hourlyRate');
                    if (!rate || !rate.value || Number(rate.value) <= 0) {
                        return { valid: false, message: 'Informe um pre√ßo por hora v√°lido.', field: rate };
                    }
                }
            }

            return { valid: true };
        }

        async function handleSubmit(event) {
            event.preventDefault();
            clearAlert();

            // validar todos os passos (garante que mesmo pulando, tudo esteja ok)
            for (let step = 1; step <= 3; step++) {
                const res = validateStep(step);
                if (!res.valid) {
                    switchToStep(step);
                    showAlert(res.message);
                    if (res.field) res.field.focus();
                    return false;
                }
            }

            // construir payload
            const formData = {
                type: userType,
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                cpf: document.getElementById('cpf').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: {
                    cep: document.getElementById('cep').value.trim(),
                    street: document.getElementById('street').value.trim(),
                    number: document.getElementById('number').value.trim(),
                    complement: document.getElementById('complement').value.trim(),
                    neighborhood: document.getElementById('neighborhood').value.trim()
                }
            };

            if (userType === 'profissional') {
                const categories = Array.from(document.querySelectorAll('input[name="categories[]"]:checked'))
                    .map(cb => cb.value);
                formData.professional = {
                    categories,
                    description: document.getElementById('description').value.trim(),
                    hourlyRate: Number(document.getElementById('hourlyRate').value)
                };
            }

            try {
                // Enviar para o backend Node (porta 3001) que exp√µe /api/auth/register
                const apiUrl = window.__API_URL__ || 'http://localhost:3001/api/auth/register';

                // mapear campos para o formato esperado pelo controller Node
                const payload = {
                    name: formData.name,
                    email: formData.email,
                    password: formData.password,
                    whatsapp: formData.phone,
                    cep: formData.address.cep,
                    address: formData.address,
                    role: userType === 'profissional' ? 'PROVIDER' : 'CLIENT'
                };

                // se for profissional, envie campos extras (o backend atual pode ignor√°-los)
                if (userType === 'profissional') {
                    payload.professional = formData.professional;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Exibe mensagem de sucesso com bot√£o para ir ao login imediato
                    showAlert(`Cadastro realizado com sucesso! <button id="goLoginBtn" class="btn btn-sm btn-light ms-2">Ir para login</button>`, 'success');
                    // Adiciona listener para o bot√£o de ir ao login
                    setTimeout(() => {
                        const btn = document.getElementById('goLoginBtn');
                        if (btn) btn.addEventListener('click', redirectToLogin);
                    }, 50);
                } else {
                    const errText = await response.text();
                    showAlert('Erro no registro: ' + (errText || response.statusText));
                }
            } catch (error) {
                showAlert('Erro ao criar conta. Por favor, tente novamente.');
                console.error(error);
            }

            return false;
        }

        // buscar endere√ßo pelo CEP (registrar ap√≥s DOM carregado)
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            const cepEl = document.getElementById('cep');
            if (cepEl) {
                cepEl.addEventListener('blur', async function() {
                    const cep = this.value.replace(/\D/g, '');
                    if (cep.length === 8) {
                        try {
                            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                            const data = await response.json();
                            if (!data.erro) {
                                document.getElementById('street').value = data.logradouro || '';
                                document.getElementById('neighborhood').value = data.bairro || '';
                            }
                        } catch (error) {
                            console.error('Erro ao buscar CEP:', error);
                        }
                    }
                });
            }
        });

        function redirectToLogin() {
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
